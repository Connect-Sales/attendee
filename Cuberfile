def google_cloud_secret(secret_name)
    return `gcloud secrets versions access latest --secret="#{secret_name}" --project="#{ENV['GOOGLE_CLOUD_PROJECT_ID']}"`
end
# Give a name to your app
app 'attendee'

# Get the code from this Git repository
repo '.'

# Build the Docker image automatically (or provide a Dockerfile)
dockerfile 'Dockerfile'

# Publish the Docker image in a registry
image 'nduncanattendee/attendee'

# Connect to this Kubernetes cluster
kubeconfig '/home/nduncan/.kube/config'

health 'https://web-service.attendee.svc.cluster.local/health'

ingress true
lb 'kubernetes.io/ingress.global-static-ip-name', 'web-static-ip'
lb 'kubernetes.io/ingress.class', 'gce'
lb 'networking.gke.io/managed-certificates', 'attendee-cert-4'

env 'DJANGO_SETTINGS_MODULE', 'attendee.settings.production'
env 'DJANGO_SECRET_KEY', google_cloud_secret('DJANGO_SECRET_KEY'), secret: true

env 'EMAIL_HOST_USER', 'noreply@mail.attendee.dev'
env 'EMAIL_HOST_PASSWORD', google_cloud_secret('EMAIL_HOST_PASSWORD'), secret: true
env 'CREDENTIALS_ENCRYPTION_KEY', google_cloud_secret('CREDENTIALS_ENCRYPTION_KEY'), secret: true
env 'DATABASE_URL', google_cloud_secret('DATABASE_URL'), secret: true
env 'ERROR_REPORTS_RECEIVER_EMAIL_ADDRESS', 'noah@attendee.dev'

# Run and scale any command on Kubernetes
proc :web, 'gunicorn attendee.wsgi'

